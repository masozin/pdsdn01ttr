<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Siswa Interaktif</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 150px;
      font-size: 1.2em;
    }

    #dataSection {
      display: none;
      animation: fadeIn 0.6s ease forwards;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .rombel-filter, .toggle-mode {
      margin: 10px 0;
    }

    .dark-mode {
      background: #121212;
      color: #e0e0e0;
    }

    .dark-mode table {
      color: white;
    }

    .dark-mode .dt-button {
      background-color: #333 !important;
      color: #fff !important;
    }

    .dark-mode .dataTables_filter input {
      background-color: #222;
      color: #fff;
    }
  </style>
</head>
<body>

  <h2>Data Siswa</h2>

  <div class="rombel-filter">
    <label for="rombelSelect">Filter Rombel: </label>
    <select id="rombelSelect">
      <option value="">-- Semua Rombel --</option>
    </select>
  </div>

  <div class="toggle-mode">
    <button id="toggleDarkMode">ðŸŒ™ Mode Gelap</button>
  </div>

  <div id="loading">Memuat data...</div>
  <div id="dataSection">
    <table id="dataTable" class="display nowrap" style="width:100%"></table>
  </div>

  <!-- JS library -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <script>
    const sheetURL = 'https://script.google.com/macros/s/AKfycbw97rv9LNYV14SEAaCbRXdbcgpYPVQy1pwH2LfJ-Ma2JG2Yb4oQWEAQfIBxKXKjLpg/exec'; // ganti ini!

    function formatDate(isoDate) {
      const d = new Date(isoDate);
      if (isNaN(d)) return isoDate;
      return d.toLocaleDateString('id-ID', {
        day: '2-digit', month: '2-digit', year: 'numeric'
      });
    }

    fetch(sheetURL)
      .then(res => res.json())
      .then(data => {
        const headers = data[0];
        const rowsRaw = data.slice(1);
        const rombelIndex = headers.findIndex(h => h.toLowerCase().includes('rombel'));
        const tanggalIndexes = headers
          .map((h, i) => h.toLowerCase().includes('tanggal') ? i : -1)
          .filter(i => i !== -1);

        const rows = rowsRaw.map(row => {
          return row.map((val, idx) => {
            if (tanggalIndexes.includes(idx)) {
              return formatDate(val);
            }
            return val;
          });
        });

        // Generate Rombel filter
        const uniqueRombels = [...new Set(rows.map(row => row[rombelIndex]))].sort();
        uniqueRombels.forEach(r => {
          $('#rombelSelect').append(`<option value="${r}">${r}</option>`);
        });

        const columns = headers.map(title => ({ title }));

        const table = $('#dataTable').DataTable({
          data: rows,
          columns: columns,
          responsive: true,
          paging: true,
          searching: true,
          dom: 'Bfrtip',
          buttons: [
            'copyHtml5',
            'excelHtml5',
            'csvHtml5',
            'pdfHtml5',
            'print'
          ]
        });

        $('#rombelSelect').on('change', function () {
          const selected = $(this).val();
          if (selected) {
            table.column(rombelIndex).search('^' + selected + '$', true, false).draw();
          } else {
            table.column(rombelIndex).search('').draw();
          }
        });

        $('#loading').hide();
        $('#dataSection').fadeIn(500);
      });

    // Toggle dark mode
    $('#toggleDarkMode').on('click', function () {
      $('body').toggleClass('dark-mode');
    });
  </script>

</body>
</html>
